import streamlit as st
import google.generativeai as genai
from PIL import Image

# ================= 1. å…¨å±€é…ç½® =================
st.set_page_config(
    page_title="ä¸€å¶æ‘‡é£ | å½±åƒç§æ•™", 
    page_icon="ğŸƒ", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# è¯»å– Key
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("âš ï¸ è¯·åœ¨ Streamlit åå° Secrets é…ç½® GOOGLE_API_KEY")
    st.stop()

# ================= 2. å®šä¹‰åŒé‡äººè®¾ (æç¤ºè¯å‡çº§) =================

# --- æ—¥å¸¸æ¨¡å¼ï¼šé€šä¿—æ˜“æ‡‚ + å…·ä½“æ•°å€¼ ---
PROMPT_DAILY = """
ä½ æ˜¯ä¸€ä½äº²åˆ‡ä½†ä¸“ä¸šçš„æ‘„å½±å¸ˆâ€œä¸€å¶æ‘‡é£â€ã€‚
ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ æ—¥å¸¸ç…§ç‰‡ã€‚è¯·ä¸è¦åªè¯´ç©ºè¯ï¼Œè¦ç»™å‡ºèƒ½ç›´æ¥æ“ä½œçš„â€œä½œä¸šâ€ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown ç»“æ„è¾“å‡ºï¼ˆä¸è¦åŒ…å«å…¶ä»–åºŸè¯ï¼‰ï¼š

# ğŸŒŸ ç»¼åˆè¯„åˆ†: {åˆ†æ•°}/10

### ğŸ“ å½±åƒå¿«è¯„
> ç”¨ç®€ç»ƒã€æ¸©æš–çš„è¯­è¨€ç‚¹è¯„è¿™å¼ ç…§ç‰‡çš„æ°›å›´å’Œæ„å›¾ä¼˜ç¼ºç‚¹ã€‚

### ğŸ¨ æ‰‹æœºä¿®å›¾ä½œä¸š (å¯ä»¥ç›´æ¥æŠ„)
*è¯·ç»™å‡ºå…·ä½“çš„æ‰‹æœºç›¸å†Œ/é†’å›¾è°ƒæ•´æ•°å€¼ï¼ˆä¼°ç®—å€¼ï¼‰ï¼š*
* **æ›å…‰/äº®åº¦:** (ä¾‹å¦‚ï¼š+10)
* **å¯¹æ¯”åº¦:** (ä¾‹å¦‚ï¼š-5ï¼Œè®©ç”»é¢æŸ”å’Œ)
* **é¥±å’Œåº¦:** (ä¾‹å¦‚ï¼š+5ï¼Œå¢åŠ é²œè‰³åº¦)
* **è‰²æ¸©/æš–è‰²:** (ä¾‹å¦‚ï¼šå¾€å³æ‹‰ä¸€ç‚¹ï¼Œå˜æš–)
* **é«˜å…‰/é˜´å½±:** (ä¾‹å¦‚ï¼šé«˜å…‰-20ï¼Œé˜´å½±+15)

### ğŸ“¸ æ‹æ‘„å°è´´å£«
* å¦‚æœä¸‹æ¬¡å†æ‹è¿™ç§åœºæ™¯ï¼Œæ€ä¹ˆæ‹æ›´å¥½çœ‹ï¼Ÿ(æ¯”å¦‚ï¼šæ‰‹æœºæ”¾ä½ä¸€ç‚¹ã€åˆ©ç”¨çª—æˆ·å…‰ç­‰)

---
**ğŸƒ ä¸€å¶æ‘‡é£å¯„è¯­:** {ç»™æ‘„å½±å¸ˆä¸€å¥ç®€çŸ­çš„ã€å¯Œæœ‰è¯—æ„æˆ–å“²ç†çš„é¼“åŠ±}
"""

# --- ä¸“ä¸šæ¨¡å¼ï¼šæ·±åº¦è§£æ + å½±è°ƒç¾å­¦ ---
PROMPT_PRO = """
ä½ æ˜¯ä¸€ä½æå…¶ä¸¥æ ¼çš„è§†è§‰è‰ºæœ¯æ€»ç›‘â€œä¸€å¶æ‘‡é£â€ã€‚
ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ æ‘„å½±ä½œå“ï¼Œè¯·è¿›è¡Œå•†ä¸šçº§/è‰ºæœ¯çº§çš„æ·±åº¦æ‹†è§£ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown ç»“æ„è¾“å‡ºï¼ˆè¯„åˆ†å¿…é¡»åœ¨ç¬¬ä¸€è¡Œï¼‰ï¼š

# ğŸ† è‰ºæœ¯ç»¼è¯„: {åˆ†æ•°}/10

### ğŸ‘ï¸ æ·±åº¦è§†è§‰è§£æ
* **æ„å›¾è¯­è¨€:** (åˆ†æè§†è§‰å¼•å¯¼çº¿ã€é€è§†å…³ç³»ã€è´Ÿç©ºé—´è¿ç”¨)
* **å…‰å½±è´¨æ„Ÿ:** (åˆ†æå…‰è´¨è½¯ç¡¬ã€å…‰æ¯”æ§åˆ¶ã€å½±è°ƒé£æ ¼å¦‚Low-key/High-key)
* **è‰²å½©æƒ…ç»ª:** (åˆ†æé…è‰²æ–¹æ¡ˆã€è‰²å½©å¿ƒç†å­¦å½±å“)

### ğŸ¨ å•†ä¸šçº§ä¿®å›¾æ–¹æ¡ˆ (Lightroom/Capture One)
*è¯·ç»™å‡ºä¸“ä¸šçš„è°ƒè‰²æ€è·¯å’Œå‚æ•°æ–¹å‘ï¼š*
* **æ›²çº¿/è‰²é˜¶:** (ä¾‹å¦‚ï¼šSå‹æ›²çº¿å¢å¼ºå¯¹æ¯”ï¼Œæå‡æš—éƒ¨ç°åº¦...)
* **HSL/æ··è‰²:** (ä¾‹å¦‚ï¼šçº¢è‰²æ˜åº¦+10ï¼Œæ©™è‰²é¥±å’Œåº¦-5ï¼Œç»Ÿä¸€è‚¤è‰²...)
* **è´¨æ„Ÿä¸ç»†èŠ‚:** (ä¾‹å¦‚ï¼šæ¸…æ™°åº¦+15ï¼Œæ·»åŠ å™ªç‚¹é¢—ç²’...)
* **å±€éƒ¨å¤„ç†:** (ä¾‹å¦‚ï¼šä½¿ç”¨å¾„å‘æ¸å˜å‹æš—å››å‘¨ï¼Œçªå‡ºä¸»ä½“...)

### ğŸ“ å¤§å¸ˆè¿›é˜¶è¯¾
* å‰æœŸæ‹æ‘„æ—¶è¿˜å¯ä»¥å¦‚ä½•æè‡´ä¼˜åŒ–ï¼Ÿ(ç„¦æ®µã€å¸ƒå…‰ã€æƒ…ç»ªå¼•å¯¼)

---
**ğŸƒ ä¸€å¶æ‘‡é£å¯„è¯­:** {ç»™æ‘„å½±å¸ˆä¸€å¥æ·±åˆ»çš„ã€å…³äºæ‘„å½±è‰ºæœ¯çš„è§è§£}
"""

# ================= 3. ä¸»ç¨‹åº =================
def main():
    # --- ä¾§è¾¹æ  ---
    with st.sidebar:
        st.title("ğŸƒ å¼•æ“è®¾ç½®")
        
        mode = st.radio(
            "é€‰æ‹©ç§æ•™æ¨¡å¼:", 
            ["ğŸ“· æ—¥å¸¸å¿«è¯„ (Daily)", "ğŸ§ ä¸“ä¸šè‰ºæœ¯ (Professional)"],
            captions=[
                "Gemini 2.0 Flash Lite | æ‰‹æœºä¿®å›¾å‚æ•°ï¼Œé€šä¿—æ˜“æ‡‚", 
                "Gemini 2.5 Flash | å•†ä¸šçº§åˆ†æï¼Œæ·±åº¦ç¾å­¦"
            ]
        )
        
        # é€»è¾‘æ˜ å°„
        if "Daily" in mode:
            real_model = "gemini-2.0-flash-lite-preview-02-05"
            active_prompt = PROMPT_DAILY
            btn_label = "ğŸš€ è·å–ä¿®å›¾ä½œä¸š (æ•°å€¼ç‰ˆ)"
        else:
            real_model = "gemini-2.5-flash"
            active_prompt = PROMPT_PRO
            btn_label = "ğŸ’ å¼€å§‹æ·±åº¦è§£æ"
            
        st.divider()
        st.info("ğŸ’¡ æç¤ºï¼šæ—¥å¸¸æ¨¡å¼ç°åœ¨ä¹Ÿä¼šæä¾›å…·ä½“çš„ä¿®å›¾æ•°å€¼å»ºè®®ã€‚")

    # --- ä¸»ç•Œé¢ ---
    st.title("ğŸƒ ä¸€å¶æ‘‡é£ | å½±åƒç§æ•™")
    
    # é¡¶éƒ¨çŠ¶æ€
    if "Daily" in mode:
        st.caption("å½“å‰æ¨¡å¼ï¼šæ—¥å¸¸è®°å½• | é‡ç‚¹ï¼šç»™å‡ºå…·ä½“çš„æ‰‹æœºä¿®å›¾æ•°å€¼")
    else:
        st.caption("å½“å‰æ¨¡å¼ï¼šä¸“ä¸šè‰ºæœ¯ | é‡ç‚¹ï¼šæ·±åº¦å½±è°ƒåˆ†æä¸å•†ä¸šä¿®å›¾æ€è·¯")

    tab1, tab2 = st.tabs(["ğŸ“‚ ä¸Šä¼ æ–‡ä»¶", "ğŸ“· ç°åœºæ‹æ‘„"])
    image_data = None

    with tab1:
        uploaded_file = st.file_uploader(" ", type=["jpg", "jpeg", "png", "webp"])
        if uploaded_file:
            image_data = Image.open(uploaded_file)

    with tab2:
        camera_file = st.camera_input("ç‚¹å‡»æ‹æ‘„")
        if camera_file:
            image_data = Image.open(camera_file)

    # --- åˆ†æä¸å±•ç¤º ---
    if image_data:
        st.divider()
        col1, col2 = st.columns([1, 1.3]) # å³ä¾§ç¨å¾®å®½ä¸€ç‚¹ï¼Œæ”¾æ–‡å­—
        
        with col1:
            st.image(image_data, caption="åŸå§‹å½±åƒ", use_container_width=True)
        
        with col2:
            # è¿™é‡Œçš„ subheader å»æ‰äº†ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœï¼Œå› ä¸ºè¯„åˆ†åœ¨ç»“æœçš„ç¬¬ä¸€è¡Œ
            
            user_input = st.text_input("å‘å¯¼å¸ˆæé—® (å¯é€‰):", placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³ä¿®å‡ºèƒ¶ç‰‡æ„Ÿ...")
            
            if st.button(btn_label, type="primary", use_container_width=True):
                try:
                    status_text = "âœ¨ æ­£åœ¨è®¡ç®—ä¿®å›¾æ•°å€¼..." if "Daily" in mode else "ğŸ§  æ­£åœ¨è§£æ„å…‰å½±ç¾å­¦..."
                    
                    with st.status(status_text, expanded=True) as status:
                        
                        genai.configure(api_key=api_key)
                        model = genai.GenerativeModel(real_model, system_instruction=active_prompt)
                        
                        req = "è¯·åˆ†æè¿™å¼ å›¾ç‰‡ã€‚"
                        if user_input: req += f" ç”¨æˆ·å¤‡æ³¨ï¼š{user_input}"
                        
                        response = model.generate_content([req, image_data])
                        
                        status.update(label="âœ… åˆ†æå®Œæˆ", state="complete", expanded=False)
                    
                    # ç›´æ¥å±•ç¤ºç»“æœï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æç¤ºè¯é‡Œè§„å®šäº†ç¬¬ä¸€è¡Œå°±æ˜¯è¯„åˆ†
                    st.markdown(response.text)
                    
                except Exception as e:
                    st.error("è¿æ¥ä¸­æ–­")
                    if "404" in str(e):
                        st.warning("é”™è¯¯ï¼šæ¨¡å‹ä¸å¯ç”¨ï¼Œè¯·å°è¯•åˆ‡æ¢æ¨¡å¼ã€‚")
                    elif "429" in str(e):
                        st.warning("æç¤ºï¼šè¯·æ±‚è¿‡å¤šï¼Œè¯·ä¼‘æ¯ä¸€åˆ†é’Ÿå†è¯•ã€‚")
                    else:
                        st.warning(str(e))

if __name__ == "__main__":
    main()