import streamlit as st
import google.generativeai as genai
from PIL import Image

# ================= 1. å…¨å±€é…ç½® =================
st.set_page_config(
    page_title="ä¸€å¶æ‘‡é£ | å½±åƒç§æ•™", 
    page_icon="ğŸƒ", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# è¯»å– Key
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("âš ï¸ è¯·åœ¨ Streamlit åå° Secrets é…ç½® GOOGLE_API_KEY")
    st.stop()

# ================= 2. æ ¸å¿ƒæç¤ºè¯ (æ•°å€¼å¢å¼ºç‰ˆ) =================

# --- æ—¥å¸¸æ¨¡å¼ï¼šæ¸©æš–ç‚¹è¯„ + æ‰‹æœºä¿®å›¾è¡¨ ---
PROMPT_DAILY = """
ä½ æ˜¯ä¸€ä½æ¸©æš–ã€æœ‰å“ä½çš„æ‘„å½±åšä¸»â€œä¸€å¶æ‘‡é£â€ã€‚
ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ ç”Ÿæ´»ç…§ç‰‡ã€‚è¯·é¿å…ç¬¼ç»Ÿçš„åºŸè¯ï¼Œç»™å‡ºæœ‰æ¸©åº¦çš„ç‚¹è¯„å’Œå…·ä½“çš„ä¿®å›¾æ•°å€¼ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š

# ğŸŒŸ ç»¼åˆè¯„åˆ†: {åˆ†æ•°}/10

### ğŸ“ å½±åƒç¬”è®°
> {ç”¨ä¸€æ®µè¯ç‚¹è¯„ç…§ç‰‡çš„æ°›å›´ã€æƒ…æ„Ÿå’Œæ„å›¾ï¼Œè¦åƒæœ‹å‹ä¸€æ ·çœŸè¯šã€‚}

### ğŸ¨ æ‰‹æœºä¿®å›¾å‚æ•°è¡¨ (ç›´æ¥æŠ„ä½œä¸š)
è¯·æ ¹æ®ç…§ç‰‡æƒ…å†µï¼Œç»™å‡ºä¸€ç»„é€‚åˆ **é†’å›¾/ç¾å›¾ç§€ç§€/iPhoneè‡ªå¸¦ç¼–è¾‘** çš„è°ƒæ•´æ•°å€¼ï¼ˆä¼°ç®—å€¼ï¼‰ã€‚
è¯·ä½¿ç”¨ Markdown è¡¨æ ¼å±•ç¤ºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

| å‚æ•°é¡¹ | è°ƒæ•´æ•°å€¼ | è°ƒæ•´ç›®çš„ |
| :--- | :--- | :--- |
| **æ›å…‰/äº®åº¦** | ä¾‹å¦‚ +10 | æäº®æ•´ä½“ |
| **å¯¹æ¯”åº¦** | ä¾‹å¦‚ -5 | æŸ”å’Œç”»é¢ |
| **é¥±å’Œåº¦** | ä¾‹å¦‚ +8 | å¢åŠ æ°”è‰² |
| **è‰²æ¸©** | ä¾‹å¦‚ +15 | å¢åŠ æš–è°ƒæ°›å›´ |
| **é«˜å…‰** | ä¾‹å¦‚ -20 | æ‰¾å›å¤©ç©ºç»†èŠ‚ |
| **é˜´å½±** | ä¾‹å¦‚ +10 | æäº®æš—éƒ¨ |
| **é”åŒ–** | ä¾‹å¦‚ +5 | å¢åŠ æ¸…æ™°åº¦ |

### ğŸ“¸ éšæ‰‹æ‹å»ºè®®
* **æ„å›¾ä¼˜åŒ–:** (ä¸‹æ¬¡æ€ä¹ˆæ‹æ›´å¥½ï¼Ÿ)
* **å…‰çº¿è¿ç”¨:** (ä»€ä¹ˆå…‰çº¿ä¸‹æ‹æ›´ç¾ï¼Ÿ)

---
**ğŸƒ ä¸€å¶æ‘‡é£å¯„è¯­:** {ä¸€å¥ç®€çŸ­çš„ã€æ²»æ„ˆçš„æ‘„å½±é‡‘å¥}
"""

# --- ä¸“ä¸šæ¨¡å¼ï¼šæ·±åº¦è§£æ + LRä¸“ä¸šå‚æ•° ---
PROMPT_PRO = """
ä½ æ˜¯ä¸€ä½æå…·å®¡ç¾é«˜åº¦çš„è§†è§‰è‰ºæœ¯æ€»ç›‘â€œä¸€å¶æ‘‡é£â€ã€‚
ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ æ‘„å½±ä½œå“ã€‚è¯·ä¸è¦æ‰‹ä¸‹ç•™æƒ…ï¼Œè¿›è¡Œå•†ä¸šçº§çš„æ·±åº¦æ‹†è§£ï¼Œå¹¶æä¾›ç²¾ç¡®çš„åæœŸå‚æ•°ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š

# ğŸ† è‰ºæœ¯æ€»è¯„: {åˆ†æ•°}/10

### ğŸ‘ï¸ è§†è§‰ä¸ç¾å­¦è§£æ
* **æ„å›¾è¯­è¨€:** (åˆ†æé€è§†ã€çº¿æ¡ã€å¹³è¡¡)
* **å…‰å½±è´¨æ„Ÿ:** (åˆ†æå…‰æ¯”ã€å½±è°ƒé£æ ¼)
* **è‰²å½©æƒ…ç»ª:** (åˆ†æé…è‰²é€»è¾‘ã€è‰²å½©å¿ƒç†)

### ğŸ¨ å•†ä¸šçº§åæœŸé¢æ¿ (Lightroom / C1)
è¯·æ ¹æ®ç…§ç‰‡é—®é¢˜ï¼Œæä¾›ä¸“ä¸šçš„è°ƒè‰²å‚æ•°ã€‚è¯·ä½¿ç”¨ Markdown è¡¨æ ¼å±•ç¤ºï¼š

**1. åŸºç¡€å½±è°ƒ (Tone)**
| å‚æ•° | æ•°å€¼å»ºè®® | è§£æ |
| :--- | :--- | :--- |
| **æ›å…‰** | +/- EV | ... |
| **é«˜å…‰/ç™½è‰²** | ... | ... |
| **é˜´å½±/é»‘è‰²** | ... | ... |
| **æ›²çº¿ (Curve)** | æè¿°æ›²çº¿å½¢æ€ (å¦‚: Så‹/æé»‘/å‹é«˜å…‰) | ... |

**2. è‰²å½©åˆ†çº§ (Color)**
| å‚æ•° | æ•°å€¼å»ºè®® | è§£æ |
| :--- | :--- | :--- |
| **è‰²æ¸©/è‰²è°ƒ** | Kå€¼ / åç§» | ... |
| **HSL-çº¢è‰²** | è‰²ç›¸/é¥±å’Œ/æ˜åº¦ | æ§åˆ¶è‚¤è‰²/å”‡è‰² |
| **HSL-æ©™è‰²** | è‰²ç›¸/é¥±å’Œ/æ˜åº¦ | æ§åˆ¶è‚¤è‰²é€šé€åº¦ |
| **HSL-è“è‰²** | è‰²ç›¸/é¥±å’Œ/æ˜åº¦ | æ§åˆ¶å¤©ç©º/ç¯å¢ƒ |

**3. è´¨æ„Ÿä¸ç»†èŠ‚**
| å‚æ•° | æ•°å€¼ | è§£æ |
| :--- | :--- | :--- |
| **æ¸…æ™°åº¦/çº¹ç†** | ... | ... |
| **é¢—ç²’ (Grain)** | ... | å¢åŠ èƒ¶ç‰‡æ„Ÿ |

### ğŸ“ æå®¢è¿›é˜¶
* **å‰æœŸä¼˜åŒ–:** (ç„¦æ®µé€‰æ‹©ã€å¸ƒå…‰æ–¹æ¡ˆã€æ¨¡ç‰¹å¼•å¯¼)

---
**ğŸƒ ä¸€å¶æ‘‡é£å¯„è¯­:** {ä¸€å¥å…³äºæ‘„å½±æœ¬è´¨çš„æ·±åˆ»è§è§£}
"""

# ================= 3. ä¸»ç¨‹åºé€»è¾‘ =================
def main():
    # --- ä¾§è¾¹æ  ---
    with st.sidebar:
        st.title("ğŸƒ å¼•æ“è®¾ç½®")
        
        mode = st.radio(
            "é€‰æ‹©ç§æ•™æ¨¡å¼:", 
            ["ğŸ“· æ—¥å¸¸å¿«è¯„ (Daily)", "ğŸ§ ä¸“ä¸šè‰ºæœ¯ (Professional)"],
            captions=[
                "Gemini 2.0 Flash Lite | æ‰‹æœºä¿®å›¾è¡¨ï¼Œç®€å•ç›´æ¥", 
                "Gemini 2.5 Flash | LR/C1 æ·±åº¦å‚æ•°ï¼Œå•†ä¸šçº§"
            ]
        )
        
        if "Daily" in mode:
            real_model = "gemini-2.0-flash-lite-preview-02-05"
            active_prompt = PROMPT_DAILY
            btn_label = "ğŸš€ è·å–æ‰‹æœºä¿®å›¾å‚æ•°"
        else:
            real_model = "gemini-2.5-flash"
            active_prompt = PROMPT_PRO
            btn_label = "ğŸ’ è·å–ä¸“ä¸šè°ƒè‰²é¢æ¿"
            
        st.divider()
        st.info("ğŸ’¡ æç¤ºï¼šç”µè„‘æµè§ˆå™¨å¦‚æœæ— æ³•è°ƒç”¨ç›¸æœºï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨åœ°å€æ å³ä¾§æ˜¯å¦å…è®¸äº†æ‘„åƒå¤´æƒé™ã€‚")

    # --- ä¸»ç•Œé¢ ---
    st.title("ğŸƒ ä¸€å¶æ‘‡é£ | å½±åƒç§æ•™")
    
    # åŠ¨æ€å‰¯æ ‡é¢˜
    if "Daily" in mode:
        st.caption("å½“å‰æ¨¡å¼ï¼šæ—¥å¸¸è®°å½• | æ ¸å¿ƒï¼šæä¾›ã€é†’å›¾/ç¾å›¾ç§€ç§€ã€‘å…·ä½“å‚æ•°")
    else:
        st.caption("å½“å‰æ¨¡å¼ï¼šä¸“ä¸šè‰ºæœ¯ | æ ¸å¿ƒï¼šæä¾›ã€Lightroomã€‘HSLåŠæ›²çº¿å‚æ•°")

    # === æ ¸å¿ƒä¿®å¤ï¼šå›¾ç‰‡è¾“å…¥é€»è¾‘ä¼˜åŒ– ===
    # ä¸å†ä½¿ç”¨ tab åˆ†éš”é€»è¾‘ï¼Œè€Œæ˜¯å¹³é“ºæˆ–è€…è‡ªåŠ¨æ£€æµ‹ï¼Œé¿å…å˜é‡å†²çª
    # ä¸ºäº†ç•Œé¢ç¾è§‚ï¼Œæˆ‘ä»¬ç”¨ Expander æˆ–è€…å¹¶æ’å¸ƒå±€
    
    col_input1, col_input2 = st.columns(2)
    
    img_file_buffer = None
    
    with col_input1:
        st.markdown("### ğŸ“‚ æ–¹å¼ä¸€ï¼šä¸Šä¼ æ–‡ä»¶")
        uploaded_file = st.file_uploader("æ”¯æŒ JPG/PNG/WEBP", type=["jpg", "jpeg", "png", "webp"], key="uploader")
    
    with col_input2:
        st.markdown("### ğŸ“· æ–¹å¼äºŒï¼šæ‹æ‘„")
        camera_file = st.camera_input("ç‚¹å‡»æ‹æ‘„", key="camera")

    # ä¼˜å…ˆä½¿ç”¨ç›¸æœºï¼Œå…¶æ¬¡ä½¿ç”¨ä¸Šä¼ 
    if camera_file is not None:
        img_file_buffer = camera_file
    elif uploaded_file is not None:
        img_file_buffer = uploaded_file

    # --- åˆ†æä¸å±•ç¤º ---
    if img_file_buffer is not None:
        st.divider()
        try:
            # ä¿®å¤å›¾ç‰‡åŠ è½½é—®é¢˜ï¼šå¼ºåˆ¶è½¬æ¢ä¸º RGBï¼Œé˜²æ­¢æŸäº› PNG æ ¼å¼æŠ¥é”™
            image = Image.open(img_file_buffer).convert('RGB')
            
            col_img, col_text = st.columns([1, 1.3])
            
            with col_img:
                st.image(image, caption="å¾…åˆ†æå½±åƒ", use_container_width=True)
            
            with col_text:
                st.subheader("ğŸ’¡ æ‚¨çš„éœ€æ±‚")
                user_input = st.text_input("æƒ³æ€ä¹ˆä¿®ï¼Ÿ(å¯é€‰)", placeholder="ä¾‹å¦‚ï¼šç…§ç‰‡å¤ªç°äº†ï¼Œæƒ³é€šé€ä¸€ç‚¹ï¼›æˆ–è€…æƒ³ä¿®å‡ºæ—¥æ‚æ„Ÿã€‚")
                
                if st.button(btn_label, type="primary", use_container_width=True):
                    status_text = "âœ¨ æ­£åœ¨è®¡ç®—å‚æ•°..." if "Daily" in mode else "ğŸ§  æ­£åœ¨æ‹†è§£å…‰å½±..."
                    
                    with st.status(status_text, expanded=True) as status:
                        genai.configure(api_key=api_key)
                        model = genai.GenerativeModel(real_model, system_instruction=active_prompt)
                        
                        req = "è¯·åˆ†æè¿™å¼ å›¾ç‰‡ã€‚"
                        if user_input: req += f" ç”¨æˆ·å¤‡æ³¨ï¼š{user_input}"
                        
                        response = model.generate_content([req, image])
                        status.update(label="âœ… æ–¹æ¡ˆå·²ç”Ÿæˆ", state="complete", expanded=False)
                    
                    st.markdown(response.text)
                    
        except Exception as e:
            st.error(f"